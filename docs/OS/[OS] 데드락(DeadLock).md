# [OS] 데드락(DeadLock)

:writing_hand: *Assembled by JiYoung-Kwon (2021-01-24)* 



## 1. 데드락(DeadLock)이란?

* **둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황**
* ‘교착 상태’라고도 함
* 시스템적으로 한정된 자원을 여러 곳에서 사용하려고 할 때 발생

#### 1-1. 데드락의 문제점

* System Panic 유발
  * Timeout으로 Panic 발생
* Application 실행 중단
  * 특정 테이블에 의한 lock으로 애플리케이션 및 커널 프로세스의 실행 중단
* Performance 저하
  * 비정상적인 하나의 lock에 의해 많은 프로세스들이 wait과 sleep을 반복
* System Call 증가
  * System Call의 증가로 전체 성능 저하

<br/>

## 2. 데드락 발생 원인

1. **상호 배제** (Mutual Exclusion)
   * 한 번에 프로세스 하나만 해당 자원을 사용할 수 있다.
   * 사용 중인 자원을 다른 프로세스가 사용하려면 요청한 자원이 해제될 때까지 기다려야 한다.
2. **점유 대기** (Hold and wait)
   * 자원을 최소한 하나를 보유하고, 다른 프로세스에 할당된 자원을 점유하기 위해 대기하는 프로세스가 존재해야 한다.
3. **비선점** (No preemption)
   * 이미 할당된 자원을 강제로 빼앗을 수 없다.
4. **순환 대기** (Circular Wait)
   * 대기 프로세스의 집합이 순환 형태로 자원을 대기하고 있어야 한다.

<br/>

## 3. 데드락 해결법

크게 3가지로 분류할 수 있음

#### 3-1. 데드락 예방(Prevention)

* 데드락의 발생조건 4가지 중 **하나라도 발생하지 않게** 하는 것

  * **자원의 상호 배제 조건 방지**

    * 한 번에 여러 프로세스가 공유 자원을 사용할 수 있게 하는 것
    * 추후 동기화 관련 문제가 발생할 수 있음

  * **점유 대기 조건 방지**

    * 프로세스 실행에 필요한 모든 자원을 한꺼번에 요구하고, 허용할 때까지 작업을 보류

      -> 나중에 또 다른 자원을 점유하기 위한 대기 조건을 성립하지 않도록 함

  * **비선점 조건 방지**

    * 이미 다른 프로세스에게 할당된 자원이 선점권이 없다고 가정할 때, **높은 우선순위**의 프로세스가 해당 자원을 **선점**할 수 있도록 함

  * **순환 대기 조건 방지**

    * 자원을 순환 형태로 대기하지 않도록, 일정한 한 쪽 방향으로만 자원을 요구할 수 있도록 함

* 장점 : 가장 명료하고 널리 사용되는 방법

* 단점 : 시스템의 처리량이나 효율성을 떨어트림

<br/>

#### 3-2. 데드락 회피(Avoidance)

* 데드락 예방보다는 조금 덜 제한적인 방법, 예방법의 단점을 일부 해결할 수 있음

* Deadlock의 가능성을 알고, 발생 가능성을 미리 판단하여 프로세스를 제어

* 키워드 : **Safe sequence, Safe state** 등

* **안정 상태**(Safe state)

  * 시스템의 프로세스들이 요청하는 모든 자원을, 데드락을 발생시키지 않으면서도 차례로 모두에게 할당해 줄 수 있을 때

* **안전 순서**(Safe sequence)

  * 특정 순서로 프로세스들에게 자원을 할당, 실행 및 종료 등의 작업을 할 때 데드락이 발생하지 않는 순서

* **불안정 상태**

  * 안정 상태가 아닌 상황
  * 데드락 발생 가능성이 있는 상황
  * 교착 상태(데드락)은 불안정 상태일 때 발생할 수 있음 (교착 상태 ⊂ 불안정 상태)

* 회피 알고리즘

  * 자원을 할당한 후에도 시스템이 항상 Safe state에 있을 수 있도록 할당을 허용하자는 것이 기본 특징

  * **은행원 알고리즘**

    > <img src = https://t1.daumcdn.net/cfile/tistory/242D124B5407E3830C width = 50%>
    >
    > * E.J.Dijkstra가 제안한 기법
    > * 어떤 자원의 할당을 허용하는 지에 관한 여부를 결정하기 전에, **미리 결정된 모든 자원들의 최대 가능한 할당량을 가지고 시뮬레이션해서 Safe state에 들 수 있는지 여부**를 검사
    > * 즉, 대기 중인 다른 프로세스들의 활동에 대한 교착 상태 가능성을 미리 조사하는 것
    > * **자원 할당량을 사전에 파악**하고 데드락을 회피할 수 있게 해줌
    > * 단점
    >   * 미리 최대 자원 요구량을 알아야 하고, 할당할 수 있는 자원 수가 일정해야 하는 등 사용에 있어서 **제약 조건이 많음** & **자원 이용도 하락**

<br/>

#### 3-3. 데드락 탐지(Detection) 및 회복(Recovery)

* 시스템이 데드락 예방이나 회피법을 사용하지 않았을 때, 데드락이 발생할 수 있으니 **데드락을 탐지하고, 회복하는 알고리즘**을 사용

* **탐지 기법**

  * Allocation, Request, Available 등으로 시스템에 **데드락이 발생했는지 여부를 탐색**

    -> 은행원 알고리즘 방식과 유사하게 현재 시스템 자원 할당 상태를 가지고 파악

  * **자원 할당 그래프를 통해 탐지**하는 방법도 있음

* **회복 기법**

  * 탐지 기법을 통해 데드락을 발견했다면, **순환 대기에서 벗어나 데드락으로부터 회복하기 위한 방법을 사용**
  * 단순히 프로세스를 1개 이상 중단시키기
    * 교착 상태에 빠진 **모든** 프로세스를 중단시키는 방법
      * 계속 연산 중이던 프로세스도 모두 일시에 중단되어 부분 결과가 폐기될 수 있는 부작용이 발생할 수 있음
    * 프로세스를 **하나씩 중단시킬 때 마다** 탐지 알고리즘으로 데드락을 탐지하면서 회복시키는 방법
      * 매번 탐지 알고리즘을 호출 및 수행해야 하므로 부담이 되는 작업일 수 있음
  * 자원 선점하기
    * 프로세스에 할당된 자원을 선점해서, 교착 상태를 해결할 때까지 그 자원을 다른 프로세스에 할당해주는 방법
    * 우선 순위가 낮은 프로세스, 수행된 횟수가 적은 프로세스 등을 위주로 프로세스의 자원을 선점

<br/>



## 💡 예상질문

Q1 - 교착상태란 무엇인가요?

A1 - 둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황입니다.

<br/>

Q2 - 교착상태를 해결하기 위한 방법에는 무엇이 있나요?

A2 - 교착 상태가 발생하기 전에 발생 조건을 제거하는 예방 기법, 교착 상태의 가능성을 파악하여 회피하는 회피 기법, 교착상태가 발생했는지 탐지하고 회복하는 기법이 있습니다.

<br/>

Q3 - 회피 알고리즘 중 은행원 알고리즘에 대해 설명해보세요.

A3 - 다익스트라가 제안한 기법으로 어떤 자원의 할당을 허용하는 지에 관한 여부를 결정하기 전에, 대기 중인 다른 프로세스들의 활동에 대한 교착 상태 가능성을 미리 조사하는 방식입니다.

<br/>

## :page_with_curl: Reference

[[운영체제] 데드락(Deadlock, 교착 상태)이란?](https://chanhuiseok.github.io/posts/cs-2/)

[[운영체제 - Deadlock]](https://m.blog.naver.com/PostView.nhn?blogId=scw0531&logNo=221420360531&proxyReferer=https:%2F%2Fwww.google.com%2F)

[[운영체제] 데드락, 교착상태 해결 (Dead lock)](https://includestdio.tistory.com/12)

